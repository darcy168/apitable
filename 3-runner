# stage runner
FROM apitable/node:v16.15.0 AS runner

WORKDIR /app

ENV NODE_ENV production

ARG SEMVER_FULL
ENV SEMVER_FULL=${SEMVER_FULL}

# agenthub
COPY room-server_2-builder/app-config.json /root/
COPY room-server_2-builder/app /

RUN npm config set registry https://registry.npm.taobao.org

RUN npm install pm2@latest --global  \
    && rm -fr packages/*/src \
    && rm -fr packages/room-native-api/target

# (room|socket):http
EXPOSE 3001
EXPOSE 3333
# room:grpc port
EXPOSE 3334
# socket:notification
EXPOSE 3002
# socket:datasheet
EXPOSE 3006
# socket:room
EXPOSE 3005
# socket:rpcx
EXPOSE 3007

CMD [ "pm2-runtime", "packages/room-server/ecosystem.config.js" ]
